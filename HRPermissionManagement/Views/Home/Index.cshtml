@model HRPermissionManagement.Models.DashboardViewModel

@{
    ViewData["Title"] = "Dashboard";
    bool isAdmin = User.IsInRole("Admin");
    bool isManager = User.HasClaim(c => c.Type == "IsManager");
}

<div class="mb-8 animate-fade-in-up">
    <div
        class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-sm p-6 flex flex-col md:flex-row items-center justify-between border-l-4 border-brand-500 relative overflow-hidden group">
        <div
            class="absolute inset-0 bg-gradient-to-r from-brand-50/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
        </div>
        <div class="flex items-center mb-4 md:mb-0 relative z-10">
            <div
                class="bg-brand-50 p-4 rounded-full mr-5 shadow-sm group-hover:scale-110 transition-transform duration-300">
                <i class="fas fa-hand-sparkles fa-lg text-brand-600"></i>
            </div>
            <div>
                <h5 class="text-2xl font-black text-slate-800 tracking-tight">Hoşgeldiniz, @User.Identity?.Name!</h5>
                <p class="text-slate-500 font-medium">HR Yönetim paneli güncel durum özetiniz.</p>
            </div>
        </div>
        <div class="text-right text-slate-400 font-semibold text-sm relative z-10 bg-slate-50/80 px-4 py-2 rounded-lg">
            @DateTime.Now.ToString("dd MMMM yyyy, dddd", new System.Globalization.CultureInfo("tr-TR"))
        </div>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">

    <!-- 1. KUTU: KALAN İZİN -->
    <div class="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-white/20 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 overflow-hidden group animate-fade-in-up"
        style="animation-delay: 100ms;">
        <div class="p-6 relative">
            <div
                class="absolute -right-6 -top-6 w-24 h-24 bg-gradient-to-br from-green-100 to-green-50 rounded-full opacity-50 group-hover:scale-150 transition-transform duration-500 ease-out">
            </div>

            <div class="flex justify-between items-start relative z-10">
                <div>
                    <p class="text-slate-500 font-bold text-xs uppercase tracking-widest mb-2">Kalan İzin Hakkı</p>
                    <h3 class="text-4xl font-black text-slate-800 tracking-tight">
                        @Model.RemainingLeaveRight.ToString("0.##") <span
                            class="text-lg font-medium text-slate-400 ml-1">Gün</span></h3>
                </div>
                <div
                    class="bg-green-100/80 p-3 rounded-xl shadow-inner group-hover:rotate-12 transition-transform duration-300">
                    <i class="fas fa-umbrella-beach text-green-600 text-xl"></i>
                </div>
            </div>
        </div>
        <div class="bg-green-50/50 px-6 py-3 border-t border-green-100 group-hover:bg-green-50 transition-colors">
            <a href="/Leave/MyLeaves"
                class="text-sm font-bold text-green-700 hover:text-green-800 flex items-center group-hover:translate-x-1 transition-transform">
                Detayları Gör <i class="fas fa-arrow-right ml-2 text-xs"></i>
            </a>
        </div>
    </div>

    <!-- 2. KUTU: BEKLEYEN TALEPLER -->
    <div class="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-white/20 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 overflow-hidden group animate-fade-in-up"
        style="animation-delay: 200ms;">
        <div class="p-6 relative">
            <div
                class="absolute -right-6 -top-6 w-24 h-24 bg-gradient-to-br from-yellow-100 to-yellow-50 rounded-full opacity-50 group-hover:scale-150 transition-transform duration-500 ease-out">
            </div>

            <div class="flex justify-between items-start relative z-10">
                <div>
                    <p class="text-slate-500 font-bold text-xs uppercase tracking-widest mb-2">Bekleyen Talep</p>
                    <h3 class="text-4xl font-black text-slate-800 tracking-tight">@Model.PendingRequestsCount</h3>
                </div>
                <div
                    class="bg-yellow-100/80 p-3 rounded-xl shadow-inner group-hover:rotate-12 transition-transform duration-300">
                    <i class="far fa-clock text-yellow-600 text-xl"></i>
                </div>
            </div>
        </div>
        <div class="bg-yellow-50/50 px-6 py-3 border-t border-yellow-100 group-hover:bg-yellow-50 transition-colors">
            <a href="/Leave/Index"
                class="text-sm font-bold text-yellow-700 hover:text-yellow-800 flex items-center group-hover:translate-x-1 transition-transform">
                İncele <i class="fas fa-arrow-right ml-2 text-xs"></i>
            </a>
        </div>
    </div>

    <!-- 3. KUTU: TOPLAM PERSONEL (Sadece Admin) -->
    @if (isAdmin)
    {
        <div class="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-white/20 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 overflow-hidden group animate-fade-in-up"
            style="animation-delay: 300ms;">
            <div class="p-6 relative">
                <div
                    class="absolute -right-6 -top-6 w-24 h-24 bg-gradient-to-br from-brand-100 to-brand-50 rounded-full opacity-50 group-hover:scale-150 transition-transform duration-500 ease-out">
                </div>

                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <p class="text-slate-500 font-bold text-xs uppercase tracking-widest mb-2">Toplam Personel</p>
                        <h3 class="text-4xl font-black text-slate-800 tracking-tight">@Model.TotalEmployeeCount</h3>
                    </div>
                    <div
                        class="bg-brand-100/80 p-3 rounded-xl shadow-inner group-hover:rotate-12 transition-transform duration-300">
                        <i class="fas fa-users-cog text-brand-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-brand-50/50 px-6 py-3 border-t border-brand-100 group-hover:bg-brand-50 transition-colors">
                <a href="/Employee/Index"
                    class="text-sm font-bold text-brand-700 hover:text-brand-800 flex items-center group-hover:translate-x-1 transition-transform">
                    Yönet <i class="fas fa-arrow-right ml-2 text-xs"></i>
                </a>
            </div>
        </div>
    }

</div>

@* --- YAN YANA TABLO VE GRAFİK BÖLÜMÜ --- *@
@if (isAdmin || isManager)
{
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8 animate-fade-in-up" style="animation-delay: 400ms;">

        <!-- YAKLAŞAN İZİNLER TABLOSU -->
        <div
            class="@(isAdmin ? "" : "lg:col-span-2") bg-white/90 backdrop-blur-md rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between">
                <h3 class="font-bold text-slate-700 flex items-center">
                    <i class="fas fa-calendar-alt mr-2 text-brand-500"></i>
                    Yaklaşan İzinler (30 Gün)
                </h3>
                <span
                    class="text-xs font-bold px-3 py-1 bg-white border border-slate-200 rounded-full text-slate-500 shadow-sm">Güncel</span>
            </div>
            <div class="overflow-x-auto flex-1">
                <table class="w-full text-left text-sm text-slate-600">
                    <thead
                        class="bg-slate-50/80 text-slate-500 uppercase font-bold text-xs tracking-wider border-b border-slate-200">
                        <tr>
                            <th class="px-6 py-3">Personel</th>
                            <th class="px-6 py-3">Departman</th>
                            <th class="px-6 py-3">Başlangıç</th>
                            <th class="px-6 py-3">Bitiş</th>
                            <th class="px-6 py-3">Gün</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        @if (Model.UpcomingLeaves != null && Model.UpcomingLeaves.Any())
                        {
                            @foreach (var item in Model.UpcomingLeaves)
                            {
                                <tr class="hover:bg-brand-50/30 transition-colors group">
                                    <td class="px-6 py-4 font-bold text-slate-800 group-hover:text-brand-700 transition-colors">
                                        @item.Employee?.Name @item.Employee?.Surname
                                    </td>
                                    <td class="px-6 py-4"><span
                                            class="px-2 py-1 bg-slate-100 text-slate-600 rounded text-xs font-bold border border-slate-200">@item.Employee?.Department?.Name</span>
                                    </td>
                                    <td class="px-6 py-4">@item.StartDate.ToString("dd.MM")</td>
                                    <td class="px-6 py-4">@item.EndDate.ToString("dd.MM")</td>
                                    <td class="px-6 py-4 font-bold text-slate-800">
                                        @if (item.LeaveType != null && item.LeaveType.IsHourly)
                                        {
                                            <span>@((item.NumberOfDays * 9).ToString("0.##")) Saat</span>
                                        }
                                        else
                                        {
                                            <span>@item.NumberOfDays.ToString("0.##") Gün</span>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="5" class="px-6 py-12 text-center text-slate-400">
                                    <div class="flex flex-col items-center justify-center">
                                        <div class="bg-slate-50 p-4 rounded-full mb-3 animate-pulse-slow">
                                            <i class="fas fa-coffee fa-2x text-slate-300"></i>
                                        </div>
                                        <p>Önümüzdeki 30 gün planlanmış izin yok.</p>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- GRAFİK BÖLÜMÜ (SADECE ADMIN) -->
        @if (isAdmin)
        {
            var deptNames = ViewBag.DeptNames as List<string>;
            var hasData = deptNames != null && deptNames.Any();

            <div
                class="bg-white/90 backdrop-blur-md rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-full">
                <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                    <h3 class="font-bold text-slate-700 flex items-center">
                        <i class="fas fa-chart-pie mr-2 text-violet-500"></i>
                        Personel Dağılımı
                    </h3>
                </div>
                <div class="p-6 flex-1 flex items-center justify-center relative bg-gradient-to-b from-white to-slate-50/50">
                    @if (hasData)
                    {
                        <div class="w-full h-80">
                            <canvas id="donutChart"></canvas>
                        </div>
                    }
                    else
                    {
                        <div class="flex flex-col items-center justify-center text-slate-400">
                            <div class="bg-slate-50 p-4 rounded-full mb-3">
                                <i class="fas fa-chart-pie fa-2x text-slate-300"></i>
                            </div>
                            <p class="text-sm font-medium">Görüntülenecek veri bulunamadı.</p>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
}

@* --- SCRIPTS (Sadece Admin için render edilir) --- *@
@if (isAdmin)
{
    var deptNames = ViewBag.DeptNames as List<string>;
    var hasData = deptNames != null && deptNames.Any();

    @if (hasData)
    {
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                try {
                    // Veriler Razor'dan geliyor
                    var deptNames = @Html.Raw(Json.Serialize(ViewBag.DeptNames));
                    var deptCounts = @Html.Raw(Json.Serialize(ViewBag.DeptCounts));

                    var chartCanvas = document.getElementById('donutChart');

                    if (chartCanvas && typeof Chart !== 'undefined') {
                        var ctx = chartCanvas.getContext('2d');

                        new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: deptNames,
                                datasets: [{
                                    data: deptCounts,
                                    backgroundColor: [
                                        '#0ea5e9', '#8b5cf6', '#10b981', '#f59e0b',
                                        '#f43f5e', '#6366f1', '#06b6d4', '#84cc16',
                                        '#64748b', '#a8a29e'
                                    ],
                                    borderWidth: 0,
                                    hoverOffset: 15
                                }]
                            },
                            options: {
                                maintainAspectRatio: false,
                                responsive: true,
                                layout: { padding: 20 },
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            font: { family: "'Inter', sans-serif", weight: '600' },
                                            color: '#64748b',
                                            usePointStyle: true,
                                            padding: 25,
                                            pointStyle: 'circle'
                                        }
                                    }
                                },
                                cutout: '75%'
                            }
                        });
                    }
                } catch (e) {
                    console.error("Error initializing chart:", e);
                }
            });
        </script>
    }
}